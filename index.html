<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotas CSGO - Rifas de Skins Dinâmicas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
        }
        .progress-bar-container {
            height: 24px;
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        .progress-bar {
            height: 100%;
            background-color: #3b82f6; /* sky-500 */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            position: relative;
            background-color: #1f2937;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style for the padlock icon and admin panel */
        #admin-access-icon {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280; /* gray-500 */
            transition: color 0.3s;
        }
        #admin-access-icon:hover {
            color: #9ca3af; /* gray-400 */
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Admin Access Icon (Padlock) -->
    <div id="admin-access-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a2 2 0 0 0-2 2v4H5a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H9V3a1 1 0 0 1 2 0v4a.5.5 0 0 0 1 0V3a2 2 0 0 0-2-2z"/>
            <path d="M12.5 9a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm-10 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5z"/>
        </svg>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white">
                Cotas CSGO
            </a>
            <div class="hidden md:flex space-x-6">
                <a href="#premio" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Prêmio Principal</a>
                <a href="#como-funciona" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Como Funciona</a>
                <a href="#minhas-cotas" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Minhas Cotas</a>
            </div>
            <a href="#participar" class="bg-sky-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-sky-600 transition-colors duration-300 transform hover:scale-105">
                Participar
            </a>
        </nav>
    </header>

    <!-- Hero Section -->
    <main class="py-16 md:py-24">
        <section class="container mx-auto px-4 text-center">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-4">
                    Participe e Concorra a uma <span class="text-sky-500" id="prize-name">...</span>!
                </h1>
                <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                    A sua chance de ter a skin de faca mais desejada do CS:GO 2. Cada cota pode ser a chave para o seu inventário dos sonhos!
                </p>
                <p id="raffle-status" class="text-xl font-bold mb-10 text-green-400 hidden">
                    O sorteio será realizado após a venda de todas as cotas!
                </p>
            </div>
        </section>
    </main>

    <!-- Main Prize Section -->
    <section id="premio" class="bg-gray-800 py-16 md:py-20">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center gap-12">
            <div class="w-full md:w-1/2">
                <div class="bg-gray-700 p-8 rounded-2xl shadow-xl flex items-center justify-center h-full">
                    <img id="prize-image" src="" alt="Imagem do prêmio da rifa" class="rounded-lg shadow-md max-w-full h-auto">
                </div>
            </div>
            <div class="w-full md:w-1/2 text-center md:text-left">
                <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">O Prêmio Principal: A Lenda do CS</h2>
                <p class="text-lg text-gray-300 mb-6" id="prize-description">
                    ...
                </p>
                <ul class="text-gray-300 space-y-3 mb-8 text-left inline-block md:inline" id="prize-features">
                    <!-- Features will be loaded here from the database -->
                </ul>
                <div id="loading-tickets" class="flex justify-center items-center space-x-2 text-gray-400">
                    <div class="w-4 h-4 rounded-full bg-sky-500 animate-bounce"></div>
                    <span>Carregando cotas...</span>
                </div>
                <div id="ticket-progress-info" class="mt-8 hidden">
                    <div class="progress-bar-container w-full">
                        <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="mt-2 text-sm font-semibold text-gray-400">
                        <span id="tickets-sold-count">0</span> / <span id="tickets-total-count">0</span> vendidas
                    </p>
                    <p class="mt-1 text-sm text-gray-400">
                        Restam <span id="tickets-remaining-count">0</span> cotas!
                    </p>
                </div>
                <div class="mt-8">
                    <a href="#participar" class="inline-block bg-sky-500 text-white font-semibold px-8 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300 shadow-md">
                        Garantir Minhas Cotas
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section id="como-funciona" class="py-16 md:py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-12">É Fácil de Participar!</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                <!-- Step 1 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        1
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Selecione suas Cotas</h3>
                    <p class="text-gray-400">
                        Escolha quantas cotas (números) você deseja comprar. Cada cota aumenta a sua chance!
                    </p>
                </div>
                <!-- Step 2 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        2
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Faça o Pagamento via PIX</h3>
                    <p class="text-gray-400">
                        Use o PIX para pagar de forma rápida e segura. As cotas serão reservadas para você.
                    </p>
                </div>
                <!-- Step 3 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        3
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Receba e Aguarde</h3>
                    <p class="text-gray-400">
                        Receba seus números aleatórios e aguarde o sorteio. Boa sorte!
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Buy Tickets Section -->
    <section id="participar" class="py-16 md:py-20 bg-gray-800">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-8">Compre suas Cotas</h2>
            <div class="bg-gray-900 p-8 rounded-2xl shadow-lg max-w-lg mx-auto">
                <form id="buy-form" class="space-y-6">
                    <div>
                        <label for="num-cotas" class="block text-sm font-medium text-gray-300">Número de Cotas</label>
                        <input type="number" id="num-cotas" value="1" min="1" max="100" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div id="buy-form-error" class="text-red-400 text-sm hidden"></div>
                    <button type="submit" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                        Reservar Cotas
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- My Tickets Section -->
    <section id="minhas-cotas" class="py-16 md:py-20 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-8">Minhas Cotas</h2>
            <p id="user-id-display" class="text-center text-sm text-gray-400 mb-4">Seu ID de usuário: <span id="user-id">Carregando...</span></p>
            <div id="my-tickets-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 justify-items-center">
                <p id="no-tickets-message" class="col-span-full text-center text-gray-400">Você ainda não comprou nenhuma cota. Compre agora para aparecerem aqui!</p>
            </div>
        </div>
    </section>

    <!-- Admin Panel (for you to edit raffle data) -->
    <section id="admin-panel" class="py-16 md:py-20 bg-gray-950 hidden">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-8">Painel de Administração</h2>
            <div class="bg-gray-800 p-8 rounded-2xl shadow-lg max-w-2xl mx-auto">
                <form id="raffle-form" class="space-y-6 text-left mb-8">
                    <h3 class="text-xl font-bold text-white mb-2">Configuração da Rifa</h3>
                    <div>
                        <label for="form-prize-name" class="block text-sm font-medium text-gray-300">Nome do Prêmio</label>
                        <input type="text" id="form-prize-name" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="form-prize-image-url" class="block text-sm font-medium text-gray-300">URL da Imagem</label>
                        <input type="url" id="form-prize-image-url" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="form-prize-description" class="block text-sm font-medium text-gray-300">Descrição</label>
                        <textarea id="form-prize-description" rows="3" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500"></textarea>
                    </div>
                    <div>
                        <label for="form-total-tickets" class="block text-sm font-medium text-gray-300">Total de Cotas</label>
                        <input type="number" id="form-total-tickets" min="1" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="form-features" class="block text-sm font-medium text-gray-300">Características (uma por linha)</label>
                        <textarea id="form-features" rows="4" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                            Salvar Alterações
                        </button>
                    </div>
                    <div id="status-message" class="mt-4 text-center text-sm font-medium text-green-400"></div>
                </form>

                <!-- Admin form for validating tickets -->
                <form id="validate-form" class="space-y-6 text-left">
                    <h3 class="text-xl font-bold text-white mb-2">Validar Cota</h3>
                    <div>
                        <label for="validate-ticket-number" class="block text-sm font-medium text-gray-300">Número da Cota</label>
                        <input type="number" id="validate-ticket-number" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-green-600 transition-colors duration-300">
                            Validar Cota
                        </button>
                    </div>
                    <div id="validate-status-message" class="mt-4 text-center text-sm font-medium text-green-400"></div>
                </form>
            </div>
        </div>
    </section>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Acesso de Administrador</h3>
            <p class="text-gray-300 mb-4">Digite a senha para aceder ao painel de administração.</p>
            <form id="admin-login-form" class="space-y-4">
                <input type="password" id="admin-password-input" class="w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500" placeholder="Senha">
                <div id="admin-login-error" class="text-red-400 text-sm hidden">Senha incorreta.</div>
                <button type="submit" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                    Aceder
                </button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-payment-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">Pagamento via PIX</h3>
            <p class="text-gray-300 mb-4">
                Por favor, realize o pagamento via PIX para a chave abaixo. Suas cotas serão liberadas após a confirmação.
            </p>
            <div class="bg-gray-700 p-4 rounded-md mb-4">
                <p class="font-mono text-white break-words" id="pix-key-display">
                    chavepix@example.com
                </p>
            </div>
            <div class="flex items-center space-x-2 mb-4">
                <button id="copy-pix-key" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-full hover:bg-sky-600 transition-colors duration-300">
                    Copiar Chave
                </button>
                <span id="copied-message" class="text-sm text-green-400 hidden">Copiado!</span>
            </div>
            <p class="text-sm text-gray-400">
                **Importante:** Envie o comprovante de pagamento para o WhatsApp informado no rodapé para que suas cotas sejam ativadas.
            </p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-950 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 mb-4">&copy; 2025 Cotas CSGO. Todos os direitos reservados.</p>
            <div class="flex justify-center space-x-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Instagram</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">Facebook</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors duration-300">WhatsApp</a>
            </div>
        </div>
    </footer>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration, provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let raffleDocRef;
        let ticketsCollectionRef;
        let currentUserId;

        // Function to initialize Firebase and load raffle data
        async function initializeAppAndLoadData() {
            try {
                // Initialize Firebase app only if config is available
                if (firebaseConfig) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in anonymously if no auth token is provided
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Get the user ID after successful sign-in
                    currentUserId = auth.currentUser?.uid;

                    if (!currentUserId) {
                        console.error("User ID not available after authentication.");
                        return;
                    }
                    
                    document.getElementById('user-id').textContent = currentUserId;

                    // Define the path to the raffle document with an even number of segments, as required by Firestore.
                    const raffleDocPath = `/artifacts/${appId}/public/data/raffle_configs/main_raffle`;
                    raffleDocRef = doc(db, raffleDocPath);
                    ticketsCollectionRef = collection(db, `${raffleDocPath}/tickets`);

                    // Set up real-time listeners for raffle data and tickets
                    onSnapshot(raffleDocRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            console.log("Raffle data loaded:", data);
                            updateUI(data);
                            populateAdminForm(data);
                            // Set the max value of the number of tickets input field
                            document.getElementById('num-cotas').max = data.totalTickets;
                        } else {
                            // If the document doesn't exist, create an initial one
                            console.log("No initial raffle data found. Creating a placeholder document.");
                            const initialData = {
                                prizeName: "Karambit | Doppler",
                                imageUrl: "https://placehold.co/600x400/374151/fff?text=Imagem+do+Prêmio",
                                description: "A sua chance de ter a skin de faca mais desejada do CS:GO 2. Cada cota pode ser a chave para o seu inventário dos sonhos!",
                                totalTickets: 100,
                                features: [
                                    "Estilo de inspeção único e marcante",
                                    "Skin de altíssimo valor e raridade",
                                    "Combina com qualquer luva do jogo",
                                    "Versão Factory New, com 0.01 de float"
                                ]
                            };
                            setDoc(raffleDocRef, initialData)
                                .then(() => console.log("Initial document created successfully."))
                                .catch((error) => console.error("Error creating initial document:", error));
                        }
                    }, (error) => {
                        console.error("Error listening to raffle document changes:", error);
                    });

                    // Set up a real-time listener for the tickets collection
                    onSnapshot(ticketsCollectionRef, (snapshot) => {
                        const tickets = snapshot.docs.map(doc => doc.data());
                        console.log("Tickets loaded:", tickets);
                        updateTicketProgress(tickets);
                        updateMyTickets(tickets);
                    }, (error) => {
                        console.error("Error listening to tickets collection changes:", error);
                    });

                } else {
                    console.error("Firebase config is missing. The app will not connect to Firestore.");
                }
            } catch (error) {
                console.error("Failed to initialize Firebase or load data:", error);
            }
        }

        // Function to update the UI with data from Firestore
        function updateUI(data) {
            document.getElementById('prize-name').textContent = data.prizeName || "Karambit | Doppler";
            document.getElementById('prize-image').src = data.imageUrl || "https://placehold.co/600x400/374151/fff?text=Imagem+do+Prêmio";
            document.getElementById('prize-description').textContent = data.description || "";
            
            const featuresList = document.getElementById('prize-features');
            featuresList.innerHTML = '';
            if (data.features && Array.isArray(data.features)) {
                data.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center';
                    li.innerHTML = `<span class="w-2 h-2 rounded-full bg-sky-500 mr-2"></span> ${feature}`;
                    featuresList.appendChild(li);
                });
            }

            // Show raffle status instead of countdown
            const raffleStatus = document.getElementById('raffle-status');
            const totalTickets = parseInt(document.getElementById('form-total-tickets').value);
            const soldTicketsCount = document.getElementById('tickets-sold-count').textContent;

            if (parseInt(soldTicketsCount) >= totalTickets) {
                raffleStatus.textContent = 'A rifa está encerrada! Sorteio em breve!';
                raffleStatus.classList.remove('hidden');
            } else {
                raffleStatus.textContent = 'O sorteio será realizado após a venda de todas as cotas!';
                raffleStatus.classList.remove('hidden');
            }
        }

        // Function to update the ticket progress bar and counters
        function updateTicketProgress(tickets) {
            const loading = document.getElementById('loading-tickets');
            const progressInfo = document.getElementById('ticket-progress-info');
            const totalTickets = parseInt(document.getElementById('form-total-tickets').value) || 100;
            const soldTicketsCount = tickets.length;
            const remainingTicketsCount = totalTickets - soldTicketsCount;
            const percentage = (soldTicketsCount / totalTickets) * 100;

            document.getElementById('tickets-sold-count').textContent = soldTicketsCount;
            document.getElementById('tickets-total-count').textContent = totalTickets;
            document.getElementById('tickets-remaining-count').textContent = remainingTicketsCount;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            loading.classList.add('hidden');
            progressInfo.classList.remove('hidden');
            
            // Re-run UI update to show correct raffle status
            updateUI({
                totalTickets: totalTickets,
                // Other data is not needed for this simple status update
            });
        }

        // Function to update the user's purchased tickets
        function updateMyTickets(tickets) {
            const myTicketsList = document.getElementById('my-tickets-list');
            const noTicketsMessage = document.getElementById('no-tickets-message');
            myTicketsList.innerHTML = '';
            
            const myTickets = tickets.filter(ticket => ticket.userId === currentUserId);
            
            if (myTickets.length > 0) {
                myTickets.forEach(ticket => {
                    const ticketDiv = document.createElement('div');
                    const statusColor = ticket.status === 'pending' ? 'text-yellow-400' : 'text-green-400';
                    const statusText = ticket.status === 'pending' ? 'Aguardando Pagamento' : 'Validada';
                    ticketDiv.className = `bg-gray-700 px-4 py-2 rounded-lg text-center text-white`;
                    ticketDiv.innerHTML = `<span class="font-bold text-lg">#${String(ticket.number).padStart(4, '0')}</span><br><span class="text-xs ${statusColor}">${statusText}</span>`;
                    myTicketsList.appendChild(ticketDiv);
                });
                noTicketsMessage.classList.add('hidden');
            } else {
                noTicketsMessage.classList.remove('hidden');
            }
        }

        // Function to pre-fill the form with current data
        function populateAdminForm(data) {
            document.getElementById('form-prize-name').value = data.prizeName || '';
            document.getElementById('form-prize-image-url').value = data.imageUrl || '';
            document.getElementById('form-prize-description').value = data.description || '';
            document.getElementById('form-total-tickets').value = data.totalTickets || 100;
            document.getElementById('form-features').value = (data.features || []).join('\n');
        }

        // Handle admin form submission
        async function handleAdminFormSubmit(event) {
            event.preventDefault();
            
            if (!raffleDocRef) {
                document.getElementById('status-message').textContent = 'Erro: Banco de dados não inicializado.';
                return;
            }
            
            const prizeName = document.getElementById('form-prize-name').value;
            const imageUrl = document.getElementById('form-prize-image-url').value;
            const description = document.getElementById('form-prize-description').value;
            const totalTickets = parseInt(document.getElementById('form-total-tickets').value);
            const features = document.getElementById('form-features').value.split('\n').map(f => f.trim()).filter(f => f);

            const updatedData = {
                prizeName,
                imageUrl,
                description,
                totalTickets,
                features
            };

            try {
                await setDoc(raffleDocRef, updatedData);
                document.getElementById('status-message').textContent = 'Alterações salvas com sucesso!';
                setTimeout(() => {
                    document.getElementById('status-message').textContent = '';
                }, 3000);
            } catch (error) {
                console.error("Error updating document:", error);
                document.getElementById('status-message').textContent = 'Erro ao salvar as alterações.';
            }
        }
        
        // Handle validation form submission
        async function handleValidateFormSubmit(event) {
            event.preventDefault();
            
            const ticketNumber = parseInt(document.getElementById('validate-ticket-number').value);
            const statusMessage = document.getElementById('validate-status-message');

            if (isNaN(ticketNumber) || ticketNumber <= 0) {
                statusMessage.textContent = 'Por favor, insira um número de cota válido.';
                statusMessage.classList.add('text-red-400');
                statusMessage.classList.remove('text-green-400');
                return;
            }
            
            if (!db || !ticketsCollectionRef) {
                statusMessage.textContent = 'Erro: O banco de dados não está pronto.';
                statusMessage.classList.add('text-red-400');
                statusMessage.classList.remove('text-green-400');
                return;
            }
            
            try {
                const q = query(ticketsCollectionRef, where("number", "==", ticketNumber));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    statusMessage.textContent = `Cota #${ticketNumber} não encontrada.`;
                    statusMessage.classList.add('text-red-400');
                    statusMessage.classList.remove('text-green-400');
                    return;
                }

                await runTransaction(db, async (transaction) => {
                    querySnapshot.forEach(doc => {
                        const ticketRef = doc.ref;
                        transaction.update(ticketRef, { status: 'validated' });
                    });
                });
                
                statusMessage.textContent = `Cota #${ticketNumber} validada com sucesso!`;
                statusMessage.classList.remove('text-red-400');
                statusMessage.classList.add('text-green-400');
                
            } catch (error) {
                console.error("Erro ao validar a cota:", error);
                statusMessage.textContent = `Erro ao validar a cota: ${error.message}`;
                statusMessage.classList.add('text-red-400');
                statusMessage.classList.remove('text-green-400');
            }
        }

        // Handle ticket purchase form submission
        async function handleBuyFormSubmit(event) {
            event.preventDefault();
            
            const numCotasInput = document.getElementById('num-cotas');
            const numCotas = parseInt(numCotasInput.value);
            const errorMessage = document.getElementById('buy-form-error');
            const totalTickets = parseInt(document.getElementById('form-total-tickets').value);

            if (isNaN(numCotas) || numCotas <= 0 || numCotas > totalTickets) {
                errorMessage.textContent = `Por favor, insira um número entre 1 e ${totalTickets}.`;
                errorMessage.classList.remove('hidden');
                return;
            } else {
                errorMessage.classList.add('hidden');
            }

            if (!db || !ticketsCollectionRef) {
                errorMessage.textContent = 'Erro: O banco de dados não está pronto.';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            try {
                // Now, generate and save the tickets
                await runTransaction(db, async (transaction) => {
                    const ticketsQuery = await transaction.get(ticketsCollectionRef);
                    const soldTicketNumbers = new Set(ticketsQuery.docs.map(doc => doc.data().number));
                    
                    const newTickets = [];
                    const maxAttempts = totalTickets * 2; // Safety net to prevent infinite loop
                    let attempts = 0;

                    while (newTickets.length < numCotas && attempts < maxAttempts) {
                        const newNumber = Math.floor(Math.random() * totalTickets) + 1;
                        if (!soldTicketNumbers.has(newNumber)) {
                            newTickets.push({
                                number: newNumber,
                                userId: currentUserId,
                                purchaseDate: new Date().toISOString(),
                                status: 'pending' // Tickets are pending until payment is confirmed
                            });
                            soldTicketNumbers.add(newNumber); // Add to the set to avoid duplicates in the same transaction
                        }
                        attempts++;
                    }

                    if (newTickets.length < numCotas) {
                        throw new Error("Não há cotas suficientes disponíveis para a sua compra. Por favor, tente um número menor.");
                    }

                    newTickets.forEach(ticket => {
                        const newDocRef = doc(ticketsCollectionRef);
                        transaction.set(newDocRef, ticket);
                    });
                });

                document.getElementById('payment-modal').style.display = 'block';
                console.log("Cotas salvas com sucesso no banco de dados.");
            } catch (error) {
                console.error("Transaction failed: ", error);
                document.getElementById('buy-form-error').textContent = `Erro ao salvar as cotas: ${error.message || error}`;
                document.getElementById('buy-form-error').classList.remove('hidden');
            }
        }

        // Event listeners for the forms and modal
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndLoadData();
            
            const adminForm = document.getElementById('raffle-form');
            if (adminForm) {
                adminForm.addEventListener('submit', handleAdminFormSubmit);
            }
            
            const validateForm = document.getElementById('validate-form');
            if (validateForm) {
                validateForm.addEventListener('submit', handleValidateFormSubmit);
            }

            const buyForm = document.getElementById('buy-form');
            if (buyForm) {
                buyForm.addEventListener('submit', handleBuyFormSubmit);
            }

            // Admin panel access logic
            const adminAccessIcon = document.getElementById('admin-access-icon');
            const adminPanel = document.getElementById('admin-panel');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginError = document.getElementById('admin-login-error');
            
            const ADMIN_PASSWORD = "admin123"; // CHANGE THIS PASSWORD

            adminAccessIcon.onclick = () => {
                adminLoginModal.style.display = 'block';
                adminPasswordInput.value = '';
                adminLoginError.classList.add('hidden');
            };

            adminLoginForm.onsubmit = (e) => {
                e.preventDefault();
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    adminLoginModal.style.display = 'none';
                    adminPanel.classList.remove('hidden');
                    adminAccessIcon.classList.add('hidden');
                } else {
                    adminLoginError.classList.remove('hidden');
                }
            };

            // Modal functionality
            const paymentModal = document.getElementById('payment-modal');
            const closeBtn = document.getElementById('close-payment-modal');
            closeBtn.onclick = () => { paymentModal.style.display = 'none'; };
            window.onclick = (event) => {
                if (event.target === paymentModal) {
                    paymentModal.style.display = 'none';
                }
                if (event.target === adminLoginModal) {
                    adminLoginModal.style.display = 'none';
                }
            };
            
            // Copy to clipboard functionality
            document.getElementById('copy-pix-key').onclick = () => {
                const pixKey = document.getElementById('pix-key-display').textContent;
                document.execCommand('copy');
                const copiedMessage = document.getElementById('copied-message');
                copiedMessage.classList.remove('hidden');
                setTimeout(() => {
                    copiedMessage.classList.add('hidden');
                }, 2000);
            };
        });

    </script>
</body>
</html>
