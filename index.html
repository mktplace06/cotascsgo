<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotas CSGO - Rifas de Skins Dinâmicas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://i.postimg.cc/ZKc8Gk9P/Captura-de-tela-2025-08-26-124637.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
        }
        .progress-bar-container {
            height: 24px;
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        .progress-bar {
            height: 100%;
            background-color: #3b82f6; /* sky-500 */
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            position: relative;
            background-color: #1f2937;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style for the padlock icon and admin panel */
        #admin-access-icon {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280; /* gray-500 */
            transition: color 0.3s;
        }
        #admin-access-icon:hover {
            color: #9ca3af; /* gray-400 */
        }
        .hidden {
            display: none;
        }
        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .social-icon {
            fill: #9ca3af;
            transition: fill 0.3s;
            height: 24px;
            width: 24px;
        }
        .social-icon:hover {
            fill: #ffffff;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Admin Access Icon (Padlock) -->
    <div id="admin-access-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a2 2 0 0 0-2 2v4H5a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H9V3a1 1 0 0 1 2 0v4a.5.5 0 0 0 1 0V3a2 2 0 0 0-2-2z"/>
            <path d="M12.5 9a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm-10 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5z"/>
        </svg>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-white">
                Cotas CSGO
            </a>
            <div class="hidden md:flex space-x-6">
                <a href="#premio" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Prêmio Principal</a>
                <a href="#como-funciona" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Como Funciona</a>
                <a href="#minhas-cotas" class="text-gray-300 hover:text-sky-500 transition-colors duration-300">Minhas Cotas</a>
            </div>
            <a href="#participar" class="bg-sky-500 text-white px-6 py-2 rounded-full font-semibold hover:bg-sky-600 transition-colors duration-300 transform hover:scale-105">
                Participar
            </a>
        </nav>
    </header>

    <!-- Hero Section -->
    <main class="py-16 md:py-24">
        <section class="container mx-auto px-4 text-center">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-4">
                    Participe e Concorra a uma <span class="text-sky-500" id="prize-name">...</span>!
                </h1>
                <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                    A sua chance de ter a skin de faca mais desejada do CS:GO 2. Cada cota pode ser a chave para o seu inventário dos sonhos!
                </p>
                <p id="raffle-status" class="text-xl font-bold mb-10 text-green-400 hidden">
                    O sorteio será realizado após a venda de todas as cotas!
                </p>
            </div>
        </section>
    </main>

    <!-- Main Prize Section -->
    <section id="premio" class="bg-gray-800 py-16 md:py-20">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-center gap-12">
            <div class="w-full md:w-1/2">
                <div class="bg-gray-700 p-8 rounded-2xl shadow-xl flex items-center justify-center h-full">
                    <img id="prize-image" src="" alt="Imagem do prêmio da rifa" class="rounded-lg shadow-md max-w-full h-auto">
                </div>
            </div>
            <div class="w-full md:w-1/2 text-center md:text-left">
                <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">O Prêmio Principal: A Lenda do CS</h2>
                <p class="text-lg text-gray-300 mb-6" id="prize-description">
                    ...
                </p>
                <ul class="text-gray-300 space-y-3 mb-8 text-left inline-block md:inline" id="prize-features">
                    <!-- Features will be loaded here from the database -->
                </ul>
                <div id="loading-tickets" class="flex justify-center items-center space-x-2 text-gray-400">
                    <div class="w-4 h-4 rounded-full bg-sky-500 animate-bounce"></div>
                    <span>Carregando cotas...</span>
                </div>
                <div id="ticket-progress-info" class="mt-8 hidden">
                    <div class="progress-bar-container w-full">
                        <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                    <p class="mt-2 text-sm font-semibold text-gray-400">
                        <span id="tickets-sold-count">0</span> / <span id="tickets-total-count">0</span> vendidas
                    </p>
                    <p class="mt-1 text-sm text-gray-400">
                        Restam <span id="tickets-remaining-count">0</span> cotas!
                    </p>
                </div>
                <div class="mt-8">
                    <a href="#participar" class="inline-block bg-sky-500 text-white font-semibold px-8 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300 shadow-md">
                        Garantir Minhas Cotas
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section id="como-funciona" class="py-16 md:py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-12">É Fácil de Participar!</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                <!-- Step 1 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        1
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Selecione suas Cotas</h3>
                    <p class="text-gray-400">
                        Escolha quantas cotas (números) você deseja comprar. Cada cota aumenta a sua chance!
                    </p>
                </div>
                <!-- Step 2 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        2
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Faça o Pagamento via PIX</h3>
                    <p class="text-gray-400">
                        Use o PIX para pagar de forma rápida e segura. As cotas serão reservadas para você.
                    </p>
                </div>
                <!-- Step 3 -->
                <div class="bg-gray-800 p-8 rounded-2xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-700 rounded-full flex items-center justify-center text-sky-500 font-bold text-2xl">
                        3
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Receba e Aguarde</h3>
                    <p class="text-gray-400">
                        Receba seus números aleatórios e aguarde o sorteio. Boa sorte!
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Buy Tickets Section -->
    <section id="participar" class="py-16 md:py-20 bg-gray-800">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-8">Compre suas Cotas</h2>
            <div class="bg-gray-900 p-8 rounded-2xl shadow-lg max-w-lg mx-auto">
                <form id="buy-form" class="space-y-6">
                    <div>
                        <label for="num-cotas" class="block text-sm font-medium text-gray-300">Número de Cotas</label>
                        <input type="number" id="num-cotas" value="1" min="1" max="100" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div class="text-center font-bold text-lg mt-4 mb-4">
                        Valor da Cota: <span id="ticket-price-display">R$ 0,00</span>
                    </div>
                    <div class="text-center font-bold text-lg mt-4 mb-4">
                        Valor Total: <span id="total-price">R$ 0,00</span>
                    </div>
                    <div id="buy-form-error" class="text-red-400 text-sm hidden"></div>
                    <button type="submit" id="buy-button" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                        Reservar Cotas
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- My Tickets Section -->
    <section id="minhas-cotas" class="py-16 md:py-20 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-8">Minhas Cotas</h2>
            <p id="user-id-display" class="text-center text-sm text-gray-400 mb-4">Seu ID de usuário: <span id="user-id">Carregando...</span></p>
            <div id="my-tickets-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 justify-items-center">
                <p id="no-tickets-message" class="col-span-full text-center text-gray-400">Você ainda não comprou nenhuma cota. Compre agora para aparecerem aqui!</p>
            </div>
        </div>
    </section>

    <!-- Admin Panel (for you to edit raffle data) -->
    <section id="admin-panel" class="py-16 md:py-20 bg-gray-950 hidden">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-8">Painel de Administração</h2>
            <div class="bg-gray-800 p-8 rounded-2xl shadow-lg max-w-4xl mx-auto">
                <form id="raffle-form" class="space-y-6 text-left mb-8">
                    <h3 class="text-xl font-bold text-white mb-2">Configuração da Rifa</h3>
                    <div>
                        <label for="form-prize-name" class="block text-sm font-medium text-gray-300">Nome do Prêmio</label>
                        <input type="text" id="form-prize-name" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="form-prize-image-url" class="block text-sm font-medium text-gray-300">URL da Imagem</label>
                        <input type="url" id="form-prize-image-url" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="form-prize-description" class="block text-sm font-medium text-gray-300">Descrição</label>
                        <textarea id="form-prize-description" rows="3" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="form-total-tickets" class="block text-sm font-medium text-gray-300">Total de Cotas</label>
                            <input type="number" id="form-total-tickets" min="1" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="form-ticket-price" class="block text-sm font-medium text-gray-300">Preço da Cota (R$)</label>
                            <input type="number" id="form-ticket-price" min="0.01" step="0.01" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="form-pix-key" class="block text-sm font-medium text-gray-300">Chave PIX</label>
                            <input type="text" id="form-pix-key" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500">
                        </div>
                    </div>
                    <div>
                        <label for="form-features" class="block text-sm font-medium text-gray-300">Características (uma por linha)</label>
                        <textarea id="form-features" rows="4" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                            Salvar Alterações
                        </button>
                    </div>
                    <div id="status-message" class="mt-4 text-center text-sm font-medium text-green-400"></div>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold text-white mb-4">Pedidos Pendentes</h3>
                    <div id="pending-tickets-list" class="space-y-4 text-left">
                        <!-- Pending tickets will be listed here -->
                        <p id="no-pending-tickets" class="text-gray-400 text-center">Nenhum pedido pendente no momento.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Acesso de Administrador</h3>
            <p class="text-gray-300 mb-4">Digite a senha para aceder ao painel de administração.</p>
            <form id="admin-login-form" class="space-y-4">
                <input type="password" id="admin-password-input" class="w-full rounded-md border-gray-700 bg-gray-700 text-white p-3 focus:border-sky-500 focus:ring-sky-500" placeholder="Senha">
                <div id="admin-login-error" class="text-red-400 text-sm hidden">Senha incorreta.</div>
                <button type="submit" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-full hover:bg-sky-600 transition-colors duration-300">
                    Aceder
                </button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-payment-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">Pagamento via PIX</h3>
            <p class="text-gray-300 mb-4">
                Para finalizar a sua compra, realize o pagamento no valor de <span id="payment-modal-total-price" class="font-bold text-sky-400">R$ 0,00</span> para a chave PIX abaixo.
            </p>
            <div class="bg-gray-700 p-4 rounded-md mb-4">
                <p class="font-mono text-white break-words" id="pix-key-display">
                    chavepix@example.com
                </p>
            </div>
            <div class="flex items-center space-x-2 mb-4">
                <button id="copy-pix-key" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-full hover:bg-sky-600 transition-colors duration-300">
                    Copiar Chave
                </button>
                <span id="copied-message" class="text-sm text-green-400 hidden">Copiado!</span>
            </div>
            <p class="text-sm text-gray-400">
                **Importante:** Envie o comprovante de pagamento para o WhatsApp informado no rodapé para que suas cotas sejam ativadas.
            </p>
        </div>
    </div >

    <!-- Footer -->
    <footer class="bg-gray-950 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 mb-4">&copy; 2025 Cotas CSGO. Todos os direitos reservados.</p>
            <div class="flex justify-center space-x-4">
                <a href="https://www.instagram.com" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-300">Instagram</a>
                <a href="https://www.facebook.com" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-300">Facebook</a>
                <a href="https://api.whatsapp.com/send?phone=35984511700" target="_blank" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-700 hover:bg-green-500 transition-colors duration-300">
                    <svg class="social-icon text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.04 2.1c-5.46 0-9.9 4.44-9.9 9.9 0 1.77.47 3.45 1.37 4.95L2.1 21.9l5.12-1.35c1.45.79 3.09 1.25 4.82 1.25 5.46 0 9.9-4.44 9.9-9.9C21.94 6.54 17.5 2.1 12.04 2.1zm5.55 14.54c-.22.56-.9.84-1.63.46-.73-.39-4.52-2.18-5.28-2.45-.75-.27-.58-.39-.4-.57.18-.18.4-.42.6-.68.2-.27.27-.47.18-.68-.09-.2-.33-.56-.49-.78-.17-.22-.14-.2-.25-.45-.11-.25-.9-.83-.9-1.02-.02-.2-.59-.19-.77-.19-.17 0-.36-.02-.55-.02-.2 0-.5.06-.72.33-.23.27-.88.86-.88 2.1 0 1.23.91 2.45 1.04 2.62.14.18 1.83 2.8 4.42 3.75 2.59.94 2.59.62 3.06.58.48-.04 1.2-.49 1.38-1.07.18-.58.18-.53.12-.66-.05-.13-.23-.23-.48-.36z"/>
                    </svg>
                </a>
                <a href="https://discord.gg/paz5Wz6b9Z" target="_blank" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-700 hover:bg-indigo-500 transition-colors duration-300">
                    <svg class="social-icon text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21.579 0H2.422C1.085 0 0 1.085 0 2.422v19.156C0 22.915 1.085 24 2.422 24h19.156c1.337 0 2.422-1.085 2.422-2.422V2.422C24 1.085 22.915 0 21.579 0zM17.653 18.068a.86.86 0 0 1-.784.778.85.85 0 0 1-.778-.784.86.86 0 0 1 .784-.778.85.85 0 0 1 .778.784zM15.426 15.655c-1.12.58-2.3.937-3.528.937a7.616 7.616 0 0 1-3.527-.937.86.86 0 0 1-.41-.75.85.85 0 0 1 .778-.784 10.97 10.97 0 0 0 2.917.47.86.86 0 0 1 .555.23.86.86 0 0 1 .23.555.85.85 0 0 1-.784.778zM11.998 4.09a.86.86 0 0 1 .784.778.86.86 0 0 1-.784.778c-3.13 0-5.753 2.164-5.753 5.485 0 1.157.43 2.17 1.168 2.92.298.3.57.63.81.99.27.4.49.83.65 1.29a.86.86 0 0 1-.22.868.85.85 0 0 1-.778.784c-1.12-.1-2.2-.42-3.16-.94-.88-.47-1.57-1.1-2.07-1.87-.56-.84-.87-1.8-.87-2.82 0-3.666 3.123-6.626 6.942-6.626zm-2.052 14.868c-.68-.08-1.34-.2-1.99-.37-.58-.15-1.12-.34-1.63-.56-.63-.26-1.2-.56-1.74-.89-.48-.3-1.02-.63-1.56-.98-.8-.51-1.34-1.16-1.64-1.92-.3-.76-.32-1.6-.13-2.46.19-.85.55-1.62 1.07-2.34.52-.72 1.15-1.3 1.88-1.76.81-.5 1.7-.85 2.65-1.05.95-.21 1.93-.31 2.93-.31.85 0 1.68.08 2.49.25.82.16 1.6.43 2.32.8.69.36 1.34.78 1.92 1.25.64.51 1.19 1.11 1.63 1.8.45.7.77 1.48.97 2.32.2.84.18 1.7-.06 2.53-.25.83-.67 1.57-1.25 2.22-.58.64-1.25 1.17-2.02 1.58-.78.4-1.62.69-2.52.88-.9.19-1.84.28-2.82.28zM17.153 10.998c0 1.157-.96 2.083-2.148 2.083-1.19 0-2.15-.926-2.15-2.083 0-1.157.96-2.083 2.15-2.083s2.148.926 2.148 2.083z"/>
                    </svg>
                </a>
            </div>
        </div>
    </footer>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, runTransaction, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration, provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let raffleDocRef;
        let ticketsCollectionRef;
        let currentUserId;
        let isDbReady = false;
        let raffleData = {};

        // Function to initialize Firebase and load raffle data
        async function initializeAppAndLoadData() {
            try {
                // Initialize Firebase app only if config is available
                if (firebaseConfig) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in anonymously if no auth token is provided
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Get the user ID after successful sign-in
                    currentUserId = auth.currentUser?.uid;

                    if (!currentUserId) {
                        console.error("User ID not available after authentication.");
                        return;
                    }
                    
                    document.getElementById('user-id').textContent = currentUserId;

                    // Define the path to the raffle document with an even number of segments, as required by Firestore.
                    const raffleDocPath = `/artifacts/${appId}/public/data/raffle_configs/main_raffle`;
                    raffleDocRef = doc(db, raffleDocPath);
                    ticketsCollectionRef = collection(db, `${raffleDocPath}/tickets`);

                    // Set up real-time listeners for raffle data and tickets
                    onSnapshot(raffleDocRef, (doc) => {
                        if (doc.exists()) {
                            raffleData = doc.data();
                            console.log("Raffle data loaded:", raffleData);
                            updateUI(raffleData);
                            populateAdminForm(raffleData);
                            // Set the max value of the number of tickets input field
                            document.getElementById('num-cotas').max = raffleData.totalTickets;
                        } else {
                            // If the document doesn't exist, create an initial one
                            console.log("No initial raffle data found. Creating a placeholder document.");
                            const initialData = {
                                prizeName: "Karambit | Doppler",
                                imageUrl: "https://placehold.co/600x400/374151/fff?text=Imagem+do+Prêmio",
                                description: "A sua chance de ter a skin de faca mais desejada do CS:GO 2. Cada cota pode ser a chave para o seu inventário dos sonhos!",
                                totalTickets: 100,
                                ticketPrice: 5.00, // New field for ticket price
                                pixKey: "35984511700", // New field for PIX key
                                features: [
                                    "Estilo de inspeção único e marcante",
                                    "Skin de altíssimo valor e raridade",
                                    "Combina com qualquer luva do jogo",
                                    "Versão Factory New, com 0.01 de float"
                                ]
                            };
                            setDoc(raffleDocRef, initialData)
                                .then(() => console.log("Initial document created successfully."))
                                .catch((error) => console.error("Error creating initial document:", error));
                        }
                    }, (error) => {
                        console.error("Error listening to raffle document changes:", error);
                    });

                    // Set up a real-time listener for the tickets collection
                    onSnapshot(ticketsCollectionRef, (snapshot) => {
                        const tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Tickets loaded:", tickets);
                        updateTicketProgress(tickets);
                        updateMyTickets(tickets);
                        updatePendingTicketsAdmin(tickets);
                        isDbReady = true;
                        document.getElementById('buy-button').classList.remove('disabled-button');
                        document.getElementById('buy-button').disabled = false;
                    }, (error) => {
                        console.error("Error listening to tickets collection changes:", error);
                    });

                } else {
                    console.error("Firebase config is missing. The app will not connect to Firestore.");
                }
            } catch (error) {
                console.error("Failed to initialize Firebase or load data:", error);
            }
        }

        // Function to update the UI with data from Firestore
        function updateUI(data) {
            document.getElementById('prize-name').textContent = data.prizeName || "Karambit | Doppler";
            document.getElementById('prize-image').src = data.imageUrl || "https://placehold.co/600x400/374151/fff?text=Imagem+do+Prêmio";
            document.getElementById('prize-description').textContent = data.description || "";
            
            const featuresList = document.getElementById('prize-features');
            featuresList.innerHTML = '';
            if (data.features && Array.isArray(data.features)) {
                data.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center';
                    li.innerHTML = `<span class="w-2 h-2 rounded-full bg-sky-500 mr-2"></span> ${feature}`;
                    featuresList.appendChild(li);
                });
            }

            // Show raffle status instead of countdown
            const raffleStatus = document.getElementById('raffle-status');
            const totalTickets = raffleData.totalTickets;
            const soldTicketsCount = document.getElementById('tickets-sold-count').textContent;

            if (parseInt(soldTicketsCount) >= totalTickets) {
                raffleStatus.textContent = 'A rifa está encerrada! Sorteio em breve!';
                raffleStatus.classList.remove('hidden');
            } else {
                raffleStatus.textContent = 'O sorteio será realizado após a venda de todas as cotas!';
                raffleStatus.classList.remove('hidden');
            }

            // Update ticket price and total price calculation
            const numCotasInput = document.getElementById('num-cotas');
            const totalPriceSpan = document.getElementById('total-price');
            const ticketPriceDisplay = document.getElementById('ticket-price-display');
            const ticketPrice = data.ticketPrice || 5.00;

            ticketPriceDisplay.textContent = `R$ ${ticketPrice.toFixed(2).replace('.', ',')}`;

            const updatePrice = () => {
                const updatedNumCotas = parseInt(numCotasInput.value) || 0;
                totalPriceSpan.textContent = `R$ ${(updatedNumCotas * ticketPrice).toFixed(2).replace('.', ',')}`;
            };

            numCotasInput.addEventListener('input', updatePrice);
            updatePrice(); // Initial call to set the price
            
            // Update PIX key in the modal
            document.getElementById('pix-key-display').textContent = data.pixKey || 'chavepix@example.com';
        }

        // Function to update the ticket progress bar and counters
        function updateTicketProgress(tickets) {
            const loading = document.getElementById('loading-tickets');
            const progressInfo = document.getElementById('ticket-progress-info');
            const totalTickets = raffleData.totalTickets;
            const soldTicketsCount = tickets.length;
            const remainingTicketsCount = totalTickets - soldTicketsCount;
            const percentage = (soldTicketsCount / totalTickets) * 100;

            document.getElementById('tickets-sold-count').textContent = soldTicketsCount;
            document.getElementById('tickets-total-count').textContent = totalTickets;
            document.getElementById('tickets-remaining-count').textContent = remainingTicketsCount;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            loading.classList.add('hidden');
            progressInfo.classList.remove('hidden');
            
            // Re-run UI update to show correct raffle status
            updateUI(raffleData);
        }

        // Function to update the user's purchased tickets
        function updateMyTickets(tickets) {
            const myTicketsList = document.getElementById('my-tickets-list');
            const noTicketsMessage = document.getElementById('no-tickets-message');
            myTicketsList.innerHTML = '';
            
            const myTickets = tickets.filter(ticket => ticket.userId === currentUserId);
            
            if (myTickets.length > 0) {
                myTickets.forEach(ticket => {
                    const ticketDiv = document.createElement('div');
                    const statusColor = ticket.status === 'pending' ? 'text-yellow-400' : 'text-green-400';
                    const statusText = ticket.status === 'pending' ? 'Aguardando Pagamento' : 'Validada';
                    ticketDiv.className = `bg-gray-700 px-4 py-2 rounded-lg text-center text-white`;
                    ticketDiv.innerHTML = `<span class="font-bold text-lg">#${String(ticket.number).padStart(4, '0')}</span><br><span class="text-xs ${statusColor}">${statusText}</span>`;
                    myTicketsList.appendChild(ticketDiv);
                });
                noTicketsMessage.classList.add('hidden');
            } else {
                noTicketsMessage.classList.remove('hidden');
            }
        }
        
        // Function to update the pending tickets in the admin panel
        function updatePendingTicketsAdmin(tickets) {
            const pendingTicketsList = document.getElementById('pending-tickets-list');
            pendingTicketsList.innerHTML = '';
            
            const pendingTickets = tickets.filter(ticket => ticket.status === 'pending');
            
            if (pendingTickets.length > 0) {
                pendingTickets.forEach(ticket => {
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'bg-gray-700 p-4 rounded-lg flex flex-col md:flex-row items-start md:items-center justify-between space-y-2 md:space-y-0 shadow-md';
                    ticketDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-lg text-white">Cota #${String(ticket.number).padStart(4, '0')}</p>
                            <p class="text-sm text-gray-400">Usuário: ${ticket.userId}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="validate-ticket-btn bg-green-500 text-white font-semibold px-4 py-2 rounded-full hover:bg-green-600 transition-colors duration-300" data-ticket-id="${ticket.id}">Validar</button>
                            <button class="deny-ticket-btn bg-red-500 text-white font-semibold px-4 py-2 rounded-full hover:bg-red-600 transition-colors duration-300" data-ticket-id="${ticket.id}">Negar</button>
                        </div>
                    `;
                    pendingTicketsList.appendChild(ticketDiv);
                });
                document.getElementById('no-pending-tickets').classList.add('hidden');
            } else {
                const noTicketsMessage = document.createElement('p');
                noTicketsMessage.id = 'no-pending-tickets';
                noTicketsMessage.className = 'text-gray-400 text-center';
                noTicketsMessage.textContent = 'Nenhum pedido pendente no momento.';
                pendingTicketsList.appendChild(noTicketsMessage);
            }
        }

        // Function to pre-fill the form with current data
        function populateAdminForm(data) {
            document.getElementById('form-prize-name').value = data.prizeName || '';
            document.getElementById('form-prize-image-url').value = data.imageUrl || '';
            document.getElementById('form-prize-description').value = data.description || '';
            document.getElementById('form-total-tickets').value = data.totalTickets || 100;
            document.getElementById('form-ticket-price').value = data.ticketPrice || 5.00; // Populate new field
            document.getElementById('form-pix-key').value = data.pixKey || ''; // Populate new field
            document.getElementById('form-features').value = (data.features || []).join('\n');
        }

        // Handle admin form submission
        async function handleAdminFormSubmit(event) {
            event.preventDefault();

            if (!isDbReady) {
                document.getElementById('status-message').textContent = 'Erro: Banco de dados não está pronto.';
                return;
            }
            
            const prizeName = document.getElementById('form-prize-name').value;
            const imageUrl = document.getElementById('form-prize-image-url').value;
            const description = document.getElementById('form-prize-description').value;
            const totalTickets = parseInt(document.getElementById('form-total-tickets').value);
            const ticketPrice = parseFloat(document.getElementById('form-ticket-price').value);
            const pixKey = document.getElementById('form-pix-key').value;
            const features = document.getElementById('form-features').value.split('\n').map(f => f.trim()).filter(f => f);

            const updatedData = {
                prizeName,
                imageUrl,
                description,
                totalTickets,
                ticketPrice,
                pixKey,
                features
            };

            try {
                await setDoc(raffleDocRef, updatedData);
                document.getElementById('status-message').textContent = 'Alterações salvas com sucesso!';
                setTimeout(() => {
                    document.getElementById('status-message').textContent = '';
                }, 3000);
            } catch (error) {
                console.error("Error updating document:", error);
                document.getElementById('status-message').textContent = 'Erro ao salvar as alterações.';
            }
        }
        
        // Handle validation button click
        async function handleValidateTicket(ticketId) {
            if (!isDbReady) {
                console.error('Erro: Banco de dados não está pronto.');
                return;
            }
            try {
                const ticketRef = doc(ticketsCollectionRef, ticketId);
                await setDoc(ticketRef, { status: 'validated' }, { merge: true });
                console.log(`Cota #${ticketId} validada com sucesso!`);
            } catch (error) {
                console.error("Erro ao validar a cota:", error);
            }
        }
        
        // Handle deny button click
        async function handleDenyTicket(ticketId) {
            if (!isDbReady) {
                console.error('Erro: Banco de dados não está pronto.');
                return;
            }
            try {
                const ticketRef = doc(ticketsCollectionRef, ticketId);
                await deleteDoc(ticketRef);
                console.log(`Cota #${ticketId} negada e removida.`);
            } catch (error) {
                console.error("Erro ao negar a cota:", error);
            }
        }


        // Handle ticket purchase form submission
        async function handleBuyFormSubmit(event) {
            event.preventDefault();

            if (!isDbReady) {
                document.getElementById('buy-form-error').textContent = 'Erro: Banco de dados não está pronto.';
                document.getElementById('buy-form-error').classList.remove('hidden');
                return;
            }
            
            const numCotasInput = document.getElementById('num-cotas');
            const numCotas = parseInt(numCotasInput.value);
            const errorMessage = document.getElementById('buy-form-error');
            const totalTickets = raffleData.totalTickets;

            if (isNaN(numCotas) || numCotas <= 0 || numCotas > totalTickets) {
                errorMessage.textContent = `Por favor, insira um número entre 1 e ${totalTickets}.`;
                errorMessage.classList.remove('hidden');
                return;
            } else {
                errorMessage.classList.add('hidden');
            }

            try {
                // Now, generate and save the tickets
                await runTransaction(db, async (transaction) => {
                    const ticketsQuery = await transaction.get(ticketsCollectionRef);
                    const soldTicketNumbers = new Set(ticketsQuery.docs.map(doc => doc.data().number));
                    
                    const newTickets = [];
                    const maxAttempts = totalTickets * 2; // Safety net to prevent infinite loop
                    let attempts = 0;

                    while (newTickets.length < numCotas && attempts < maxAttempts) {
                        const newNumber = Math.floor(Math.random() * totalTickets) + 1;
                        if (!soldTicketNumbers.has(newNumber)) {
                            newTickets.push({
                                number: newNumber,
                                userId: currentUserId,
                                purchaseDate: new Date().toISOString(),
                                status: 'pending' // Tickets are pending until payment is confirmed
                            });
                            soldTicketNumbers.add(newNumber); // Add to the set to avoid duplicates in the same transaction
                        }
                        attempts++;
                    }

                    if (newTickets.length < numCotas) {
                        throw new Error("Não há cotas suficientes disponíveis para a sua compra. Por favor, tente um número menor.");
                    }

                    newTickets.forEach(ticket => {
                        const newDocRef = doc(ticketsCollectionRef);
                        transaction.set(newDocRef, ticket);
                    });
                });
                
                const totalPayment = numCotas * raffleData.ticketPrice;
                document.getElementById('payment-modal-total-price').textContent = `R$ ${totalPayment.toFixed(2).replace('.', ',')}`;
                document.getElementById('payment-modal').style.display = 'block';
                console.log("Cotas salvas com sucesso no banco de dados.");
            } catch (error) {
                console.error("Transaction failed: ", error);
                document.getElementById('buy-form-error').textContent = `Erro ao salvar as cotas: ${error.message || error}`;
                document.getElementById('buy-form-error').classList.remove('hidden');
            }
        }

        // Event listeners for the forms and modal
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndLoadData();
            
            const adminForm = document.getElementById('raffle-form');
            if (adminForm) {
                adminForm.addEventListener('submit', handleAdminFormSubmit);
            }
            
            // Event delegation for dynamically created buttons in admin panel
            document.getElementById('admin-panel').addEventListener('click', (e) => {
                if (e.target.classList.contains('validate-ticket-btn')) {
                    const ticketId = e.target.getAttribute('data-ticket-id');
                    if (confirm(`Tem certeza que deseja validar a cota ${ticketId}?`)) {
                        handleValidateTicket(ticketId);
                    }
                }
                if (e.target.classList.contains('deny-ticket-btn')) {
                    const ticketId = e.target.getAttribute('data-ticket-id');
                    if (confirm(`Tem certeza que deseja negar e remover a cota ${ticketId}?`)) {
                        handleDenyTicket(ticketId);
                    }
                }
            });

            const buyForm = document.getElementById('buy-form');
            if (buyForm) {
                buyForm.addEventListener('submit', handleBuyFormSubmit);
            }
            
            document.getElementById('buy-button').classList.add('disabled-button');
            document.getElementById('buy-button').disabled = true;

            // Admin panel access logic
            const adminAccessIcon = document.getElementById('admin-access-icon');
            const adminPanel = document.getElementById('admin-panel');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginError = document.getElementById('admin-login-error');
            
            const ADMIN_PASSWORD = "admin123"; // CHANGE THIS PASSWORD

            adminAccessIcon.onclick = () => {
                adminLoginModal.style.display = 'block';
                adminPasswordInput.value = '';
                adminLoginError.classList.add('hidden');
            };

            adminLoginForm.onsubmit = (e) => {
                e.preventDefault();
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    adminLoginModal.style.display = 'none';
                    adminPanel.classList.remove('hidden');
                    adminAccessIcon.classList.add('hidden');
                } else {
                    adminLoginError.classList.remove('hidden');
                }
            };

            // Modal functionality
            const paymentModal = document.getElementById('payment-modal');
            const closeBtn = document.getElementById('close-payment-modal');
            closeBtn.onclick = () => { paymentModal.style.display = 'none'; };
            window.onclick = (event) => {
                if (event.target === paymentModal) {
                    paymentModal.style.display = 'none';
                }
                if (event.target === adminLoginModal) {
                    adminLoginModal.style.display = 'none';
                }
            };
            
            // Copy to clipboard functionality
            document.getElementById('copy-pix-key').onclick = () => {
                const pixKey = document.getElementById('pix-key-display').textContent;
                document.execCommand('copy');
                const copiedMessage = document.getElementById('copied-message');
                copiedMessage.classList.remove('hidden');
                setTimeout(() => {
                    copiedMessage.classList.add('hidden');
                }, 2000);
            };
        });

    </script>
</body>
</html>
